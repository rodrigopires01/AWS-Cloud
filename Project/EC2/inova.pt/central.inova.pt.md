## Configuration of the "central.inova.pt" instance.

#### Connect to your control.inova.pt instance and access your central.inova.pt via SSH.

```
ssh -i chave.pem ubuntu@central.inova.pt
```

<br>

Once that you're in, start by changing the hostname of the machine.

```
sudo hostnamectl set-hostname central.inova.pt
```

<br>

Now lets change user to root.
```
sudo su -
```

<br>

Lets configure our hosts so that we can easily SSH into other machines.
```
nano /etc/hosts
```
Should look something like this: 
```
172.31.100.100  control.enta.pt
172.31.100.103  www.enta.pt
172.31.100.104  central.enta.pt
172.31.100.105  wazuh.enta.pt
172.31.100.106  sales.enta.pt
172.31.100.107  marketing.enta.pt

10.0.100.100  control.inova.pt
10.0.100.103  www.inova.pt
10.0.100.104  central.inova.pt
10.0.100.105  wazuh.inova.pt
10.0.100.106  sales.inova.pt
10.0.100.107  marketing.inova.pt
```
#### Since this machine is access by a private IP and therefore it doesn't have internet connection we need to configure our netplan with the gateway and dns settings.
```
nano /etc/netplan/50-cloud-init.yaml
```
Be careful with the IPs and MAC Addresses.
```
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                use-dns: false
                use-routes: false
            routes:
              - to: 0.0.0.0/0
                via: 10.0.100.102
                on-link: true
            nameservers:
                search: [inova.pt, enta.pt]
                addresses: [10.0.100.100, 172.31.100.100]
            dhcp6: false
            match:
                macaddress: 06:4c:7d:76:a4:3b
            set-name: eth0
    version: 2
```

<br>

Lets try and apply our changes
```
netplan try
```
```
netplan apply
```

<br>

#### Now lets start installing the packages we will need.
Update the Operating System.
```
apt update && apt upgrade -y
```

<br>

Install the packages that we will be using in our instance.
```
apt install nis nfs-kernel-server postfix postfix-doc dovecot-imapd dovecot-pop3d sasl2-bin -y
```

---

#### Raid5
Go to the EC2 Volume section, create 3 disks and attach them to this instance.
Now lets create the partitions.
```
gdisk /dev/xvdf
```
```
gdisk /dev/xvdg
```
```
gdisk /dev/xvdh
```

<br>

Create the Raid5
```
mdadm --create /dev/md0 --level 5 --raid-devices 3 /dev/xvdf1 /dev/xvdg1 /dev/xvdh1
```

<br>

Encrypt your raid with luksCrypt
```
cryptsetup luksFormat --hash=sha512 --key-size=512 --cipher=aes-xts-plain64 --verify-passphrase /dev/md0
```

<br>

Decrypt temporarily your raid
```
cryptsetup luksOpen /dev/md0 md0_crypt
```

<br>

Create a physical volume using LVM
```
pvcreate /dev/mapper/md0_crypt
```

<br>

Create a volume group using LVM
```
vgcreate vg0 /dev/mapper/md0_crypt
```

<br>

Create a logical volume using LVM
```
lvcreate -n lv0 -l +100%FREE vg0
```

<br>

Make filesystem
```
mkfs.xfs /dev/vg0/lv0
```

<br>

Make a directory 
```
mkdir /mnt/raid5
```

<br>

Mount your filesystem
```
mount /dev/vg0/lv0 /mnt/raid5
```

<br>

Copy the last line.
```
cat /etc/mtab
```

<br>

Paste the line you just copied and add "nofail".
```
nano /etc/fstab
```

---

#### NFS

Edit this file and add this line at the end: "/mnt/raid5_homes  *(rw,sync,no_subtree_check)"
```
nano /etc/exports
```

<br>

Execute this command
```
exportfs -a
```

<br>

Restart the service to apply all changes.
```
systemctl restart nfs-kernel-server
```

#### NIS

Edit this file and change "NISSERVER=false" to "NISSERVER=master"
```
nano /etc/default/nis
```

<br>

Edit this file and change last line to "255.255.255.0   10.0.100.0"
```
nano /etc/ypserv.securenets
```

<br>

Edit this file
Change "MERGE_PASSWD=false" to "MERGE_PASSWD=true"
Change "MERGE_GROUP=false" to "MERGE_GROUP=true"
```
nano /var/yp/Makefile 
```

<br>

Execute this command and then press CTRL+D and then Y
```
/usr/lib/yp/ypinit -m
```

<br>

Use this everytime you create a new user so that it is update in the NIS server.
```
cd /var/yp && make
```

#### E-mail

Execute this so we can reconfigure the package. Follow this order: <br>
2ยบ Option -> inova.pt -> ubuntu -> Dont change anything -> No -> Delete everything -> 0 -> "Plus" Sign -> IPv4

```
dpkg-reconfigure postfix
```

<br>

Edit this. Change the certificates path to your own certificates.(Generated by control.inova.pt).
```
nano /etc/postfix/main.cf
```

<br>

Edit this.
```
nano /etc/postfix/master.cf
```
Uncomment first group it should look like this.
```
submission inet n       -       y       -       -       smtpd
-o syslog_name=postfix/submission
-o smtpd_tls_security_level=encrypt
-o smtpd_sasl_auth_enable=yes
#Add this line
-o smtpd_client_restrictions=permit_sasl_authenticated,reject
```
Uncomment second group it should look like this.
```
smtps     inet  n       -       y       -       -       smtpd
-o syslog_name=postfix/smtps
-o smtpd_tls_wrappermode=yes
-o smtpd_sasl_auth_enable=yes
-o smtpd_client_restrictions=permit_sasl_authenticated,reject
```

<br>

Create this file.
```
nano /etc/postfix/sasl/smtpd.conf
```
Add this
```
pwcheck_method: saslauthd
mech_list: PLAIN LOGIN
```

<br>

Edit this file. 
Modify "START=yes"
Add this line at the end: OPTIONS="-c -m /var/spool/postfix/var/run/saslauthd"
```
nano /etc/default/saslauthd
```

<br>

Execute this command
```
postconf -e 'home_mailbox = Maildir/'
```

<br>

Uncomment and change "disable_plaintext_auth = no"
```
nano /etc/dovecot/conf.d/10-auth.conf
```

<br>

Uncomment: mail_location = maildir:~/Maildir
Comment: #mail_location = mbox:~/mail:INBOX=/var/mail/%u
```
nano /etc/dovecot/conf.d/10-mail.conf
```

<br>

Uncomment and change the certificates path to your own certificates.(Generated by control.inova.pt).
```
nano /etc/dovecot/conf.d/10-ssl.conf
```

<br>

Change directory
```
cd /etc/skel/
```

<br>

Execute this command
```
maildirmake.dovecot Maildir
```

<br>

Add this users
```
adduser postfix sasl
adduser dovecot sasl
```

<br>

Finally restart everything and it should be working fine.
```
systemctl restart saslauthd.service postfix dovecot
```

## You're done, your central.inova.pt instance is fully configurated!
